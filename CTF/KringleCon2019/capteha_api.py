#!/usr/bin/env python3
# Fridosleigh.com CAPTEHA API - Made by Krampus Hollyfeld
# Solution by OperationXen

import requests
import json
import sys

from classifier import Classifier

def main():
    print("Starting ML Capteha breaker")
    yourREALemailAddress = "XXXXXXXXXXXXXXXXXX"
    classifier = Classifier()
    print("TensorFlow engine ready")

    # Creating a session to handle cookies
    s = requests.Session()
    url = "https://fridosleigh.com/"

    while True:
        print("Getting capteha images")
        json_resp = json.loads(s.get("{}api/capteha/request".format(url)).text)
        b64_images = json_resp['images']                                                                                    # A list of dictionaries eaching containing the keys 'base64' and 'uuid'
        challenge_image_type = json_resp['select_type'].split(',')                                                          # The Image types the CAPTEHA Challenge is looking for.
        challenge_image_types = [challenge_image_type[0].strip(), challenge_image_type[1].strip(), challenge_image_type[2].replace(' and ','').strip()] # cleaning and formatting
        print(f"We need {challenge_image_types[0]}, {challenge_image_types[1]} or {challenge_image_types[2]}:")

        results = classifier.get_types(b64_images)

        valid_images = []
        for result in results:
            if result['prediction'] in challenge_image_types:
                print(f"{result['uuid']} is a {result['prediction']}")
                valid_images.append(result['uuid'])

        # This should be JUST a csv list image uuids ML predicted to match the challenge_image_type .
        final_answer = ','.join(valid_images)
        print(f"Sending {final_answer}")

        json_resp = json.loads(s.post("{}api/capteha/submit".format(url), data={'answer':final_answer}).text)
        if not json_resp['request']:
            # If it fails just run again. ML might get one wrong occasionally
            print('FAILED MACHINE LEARNING GUESS')
            print('--------------------\nOur ML Guess:\n--------------------\n{}'.format(final_answer))
            print('--------------------\nServer Response:\n--------------------\n{}'.format(json_resp['data']))
        else:
            break

    print('CAPTEHA Solved!')
    # If we get to here, we are successful and can submit a bunch of entries till we win
    userinfo = {
        'name':'Krampus Hollyfeld',
        'email':yourREALemailAddress,
        'age':180,
        'about':"Cause they're so flippin yummy!",
        'favorites':'thickmints'
    }
    # If we win the once-per minute drawing, it will tell us we were emailed. 
    # Should be no more than 200 times before we win. If more, somethings wrong.
    entry_response = ''
    entry_count = 1
    while yourREALemailAddress not in entry_response and entry_count < 200:
        print('Submitting lots of entries until we win the contest! Entry #{}'.format(entry_count))
        entry_response = s.post("{}api/entry".format(url), data=userinfo).text
        entry_count += 1
    print(entry_response)


if __name__ == "__main__":
    main()